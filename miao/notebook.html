<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neko memo ฅ(๑˙o˙๑)ฅ</title>
    <link rel="shortcut icon" href="noteImages/128.png" type="image/x-icon">
    <style>
        html {
            width: 100%;
            height: 100%;
        }

        /* 背景图遮罩 */

        body {
            margin: 0;
            /* opacity: 0; */
            /* background: url(noteImages/bg-1.jpg) no-repeat 0 10%; */
            background-repeat: no-repeat;
            background-position: 0 10%;
            background-size: cover;
        }

        /* 图片加载中~ */

        .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            opacity: 1;
            visibility: visible;
            user-select: none;
            z-index: 20;
        }

        .loading {
            transition: 1s;
            opacity: 0;
            /* visibility: hidden; */
            background-color: transparent;
            z-index: -999;
        }

        button {
            border: none;
            outline: none;
        }

        ul,
        li {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        a {
            color: black;
            text-decoration: none;
        }

        header {
            display: flex;
            height: 80px;
            justify-content: space-between;
            align-items: center;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            /* background-color: rgba(0, 0, 0, .3); */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .noteCtl {
            box-sizing: border-box;
            height: 100%;
            line-height: 50px;
            cursor: pointer;
            color: #fff;
            padding-left: 8px;
            padding-right: 8px;
            margin-left: 20px;
            margin-right: 20px;
            font-size: 16px;
            font-family: consolas, 'Arial';
            border-radius: 6px;
            user-select: none;
        }

        .noteCtl:hover {
            transition: .2s;
            background-color: rgba(0, 0, 0, .3);
        }

        .content {
            /* border: 1px solid lightcoral; */
        }

        /* 每个note */

        .note {
            position: fixed;
            z-index: 10;
            /* left: 200px; */
            left: 4.2%;
            top: 13.3%;
            width: 200px;
            height: 150px;
            box-sizing: border-box;
            resize: none;
            background-color: rgba(0, 0, 0, .3);
            box-shadow: 2px 3px 7px 0 rgba(0, 0, 0, 20%);
            overflow: hidden;
        }

        .note .noteTitle {
            position: relative;
            width: 100%;
            height: 30px;
        }

        .note .noteTitle button {
            display: none;
            position: absolute;
            top: 2px;
            height: 18px;
            width: 20px;
            font-size: 16px;
            font-weight: 900;
            color: #A6ADB1;
            background-color: transparent;
            border: none;
            margin-left: 3px;
            margin-right: 5px;
            padding-top: 0;
            padding-bottom: 0;
        }

        .note .noteTitle button:last-of-type {
            right: 0;
        }

        .note .noteTitle button:hover {
            color: #555;
        }

        .note textarea {
            width: 100%;
            height: calc(100% - 30px);
            resize: none;
            box-sizing: border-box;
            margin: 0;
            border: none;
            padding: 4px;
            padding-top: 8px;
            /* padding-right: 8px; */
            outline: none;
            font-size: 16px;
            font-family: 'Open Sans', sans-serif;
            line-height: 20px;
            color: #555;
            font-style: italic;
        }

        .note textarea::-webkit-scrollbar {
            position: absolute;
            right: 0;
            top: 0;
            z-index: 1;
            cursor: default;
            width: 8px;
            background-color: transparent;
        }

        .note textarea::-webkit-scrollbar-thumb {
            display: none;
            width: 8px;
            background-color: #aaa;
            border-radius: 5px;
        }

        .note textarea::-webkit-scrollbar-button {
            display: block;
            height: 0;
            background-color: transparent;
        }

        .note:hover .noteTitle>button {
            display: block;
        }

        .note:hover textarea::-webkit-scrollbar-thumb {
            display: block;
        }

        /* 搜索框 */

        .search {
            width: 22%;
            height: 46px;
        }

        .search input {
            position: relative;
            display: block;
            box-sizing: border-box;
            padding-left: 8px;
            padding-right: 8px;
            font-size: 20px;
            font-family: 'Arial';
            line-height: 45px;
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            border-bottom: 3px solid #eeee;
            color: #333;
            background-color: transparent;
            transition: .35s;
        }

        .search input:focus {
            background-color: rgba(255, 255, 255, 0.66);
        }

        .association {
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding-top: 2px;
            padding-bottom: 2px;
        }

        .association li {
            /* width: 305px; */
            width: 100%;
            height: 40px;
            border-radius: 5px;
            padding-top: 4px;
            padding-bottom: 4px;
            box-sizing: border-box;
        }

        .association li>a {
            display: block;
            border-radius: 3px;
            box-sizing: border-box;
            width: 100%;
            height: 32px;
            padding-left: 6px;
            line-height: 32px;
            font-family: 'Arial';
        }

        .association li>a:hover {
            background: radial-gradient(farthest-side ellipse at center, #ccc9, #eee3);
        }

        .searchHover {
            background: radial-gradient(farthest-side ellipse at center, #ccc9, #eee3);
            position: relative;
        }

        /* .association li>a:hover a::after, */

        .searchHover::after {
            content: 'ฅ';
            display: block;
            position: absolute;
            right: 8px;
            top: 0;
            bottom: 0;
            margin: auto;
            font-size: 12px;
            font-family: consolas;
            color: #3339;
        }

        /* 右键菜单 */

        .colorMenu {
            position: fixed;
            box-shadow: 2px 3px 5px rgba(0, 0, 0, .2);
            z-index: 2147483647;
        }

        .colorMenu li {
            font-size: 0;
        }

        .colorMenu button {
            width: 118px;
            height: 28px;
            background-color: #fff;
            color: #000a;
            font-family: 'neue', Helvetica, Arial, sans-serif;
            font-size: 13px;
            padding: 0;
            margin: 0;
            outline: none;
            line-height: 28px;
            text-align: left;
            border: none;
            padding-left: 10px;
            cursor: default;
            letter-spacing: 1px;
        }

        .colorMenu button:hover {
            background-color: #F3EDED;
        }

        .rightTop {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        /* 切换neko背景 */

        .options {
            flex: 1;
            position: relative;
            height: 40px;
            font-size: 18px;
            text-align: center;
            line-height: 40px;
            font-family: Arial, Helvetica, sans-serif;
        }

        .options button {
            margin-left: 15px;
            margin-right: 15px;
            height: 100%;
            background-color: transparent;
            outline: none;
            cursor: pointer;
            border: none;
            font-weight: 500;
            font-size: 18px;
        }

        .options>button {
            color: #fffe;
            text-shadow: 0 0 3px #000;
        }

        .options button:hover+.optionAlt {
            display: block;
        }

        .optionAlt {
            display: none;
            position: absolute;
            left: -60px;
            font-size: 12px;
            color: #fffe;
            background-color: #0009;
            white-space: nowrap;
            padding: 5px;
            border-radius: 8px;
            line-height: 1.5;
            letter-spacing: 1.2px;
        }

        .optionAlt::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            left: 50%;
            top: -12px;
            /* transform: rotate(45deg); */
            /* background: violet; */
            transform: translateX(-50%);
            border-width: 6px 12px;
            border-style: solid;
            border-color: transparent;
            border-bottom-color: #0009;
        }

        .nekoBg {
            /* display: none; */
            visibility: hidden;
            opacity: 0;
            position: absolute;
            left: 10%;
            transform: translate(-50%);
            top: 60px;
            /* border: 2px solid lightcoral; */
            padding: 5px;
            /* z-index: -10; */
            user-select: none;
            z-index: 10;
        }

        .seeNekoBg {
            user-select: auto;
            transition: .3s;
            visibility: visible;
            opacity: 1;
        }

        .nekoBg li {
            float: left;
        }

        .nekoBg .bgTitle {
            display: flow-root;
            background-color: #F2F3F4;
            position: relative;
        }

        .nekoBg .bgTitle::after {
            content: '';
            display: block;
            position: absolute;
            right: 30px;
            top: -3px;
            width: 81px;
            height: 27px;
            background-color: #fff;
            transform: skewY(-55deg) rotate(82deg);
            z-index: -10;
            border: 5px solid #F2F3F4;
            border-left-width: 10px;
            box-sizing: border-box;
            border-radius: 11px;
        }

        .nekoBg .bgTitle::before {
            content: '';
            display: block;
            position: absolute;
            left: 30px;
            top: -3px;
            width: 81px;
            height: 27px;
            background-color: #fff;
            transform: skewY(55deg) rotate(-82deg);
            z-index: -10;
            border: 5px solid #F2F3F4;
            border-right-width: 10px;
            box-sizing: border-box;
            border-radius: 11px;
        }

        .nekoBg .bgTitle li button {
            box-sizing: border-box;
            width: 122px;
            height: 38px;
            background-color: #fff;
            color: #5692F5;
            font-family: consolas;
            text-align: center;
            line-height: 38px;
            font-size: 14px;
            padding: 0;
            margin: 0;
        }

        .nekoBg .bgBody {
            width: 560px;
            height: 400px;
            display: flow-root;
            overflow-y: scroll;
            /* background-color: #fff; */
            background-color: #eeee;
        }

        .nekoBg .bgBody::-webkit-scrollbar {
            width: 8px;
        }

        .nekoBg .bgBody::-webkit-scrollbar-thumb {
            margin-right: 3px;
            display: block;
            width: 8px;
            background-color: #aaa;
            border-radius: 5px;
            transition: .3s;
        }

        .nekoBg .bgBody::-webkit-scrollbar-thumb:hover {
            background-color: #0009;
        }

        .nekoBg .bgBody::-webkit-scrollbar-button {
            height: 0;
            background-color: transparent;
        }

        .nekoBg .bgBody li button {
            margin: 12px;
            padding: 0;
            width: 80px;
            height: 80px;
            background: url(noteImages/bg-1.jpg) no-repeat center;
            background-size: cover;
            border-radius: 50%;
            box-shadow: 2px 3px 5px rgba(0, 0, 0, .3);
        }

        /* .nekoBg .bgTitle li button {} */
        /* 左半部分 */

        .leftHeader {
            width: 300px;
        }

        /* 时钟 */

        .clock {
            cursor: default;
            /* width: 220px; */
            text-shadow: 0 0 10px rgba(0, 0, 0, 80%);
            color: #fff;
            padding-right: 20px;
            margin-right: 40px;
            margin-left: 60px;
            padding-top: 20px;
        }

        .timeClock {
            font-size: 50px;
            color: #fff;
            line-height: 40px;
            font-weight: lighter;
            font-family: Arial, Helvetica, sans-serif;
        }

        .dailyClock {
            font-size: 18px;
        }

        /* 清除提示 */

        .clearNotes {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 40;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .3);
        }

        .clearNotes>div {
            display: flex;
            flex-flow: column nowrap;
            align-items: center;
            justify-content: space-evenly;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            margin: auto;
            /* transform: translate(-50%, -50%); */
            width: 300px;
            height: 260px;
            background-color: #fff;
            border-radius: 10px;
            position: absolute;
        }

        .rightEar {
            position: absolute;
            /* right: 30px; */
            left: 10px;
            top: -3px;
            width: 120px;
            height: 45px;
            background-color: #F2F3F4;
            transform: skewY(-55deg) rotate(82deg);
            /* z-index: 1!important; */
            z-index: -1;
            box-sizing: border-box;
            border: 5px solid #fff;
            border-left-width: 16px;
            border-radius: 30px;
        }

        .leftEar {
            /* display: block; */
            position: absolute;
            /* left: 30px; */
            right: 10px;
            top: -3px;
            width: 120px;
            height: 45px;
            background-color: #F2F3F4;
            transform: skewY(55deg) rotate(-82deg);
            z-index: -1;
            box-sizing: border-box;
            border: 5px solid #fff;
            border-right-width: 16px;
            border-radius: 30px;
        }

        .clearNotes>div .alertSign {
            width: 90px;
            height: 84px;
            box-sizing: border-box;
            border: 4px solid #F8BC86;
            border-radius: 50%;
            margin-top: 20px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            animation: borderBlink 2s infinite;
        }

        .clearNotes>div .alertSign::before {
            content: '';
            height: 50px;
            width: 6px;
            border-radius: 5px;
            background-color: #F8BC86;
            /* position: absolute; */
            animation: blink 2s infinite;
        }

        .clearNotes>div .alertSign::after {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #F8BC86;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0% {
                background-color: #F8BC86;
            }

            50% {
                background-color: #eef21c;
            }

            100% {
                background-color: #F8BC86;
            }
        }

        @keyframes borderBlink {
            0% {
                border-color: #F8BC86;
            }

            50% {
                border-color: #eef21c;
            }

            100% {
                border-color: #F8BC86;
            }
        }

        .clearNotes>div p {
            user-select: none;
        }

        .clearNotes>div button {
            width: 86px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 16px;
            color: #fff;
            background-color: #C1C1C1;
            margin: 20px;
            margin-top: 0;
            border-radius: 5px;
            cursor: pointer;
        }

        .clearNotes>div button:nth-of-type(2) {
            background-color: #DD6B55;
        }
    </style>
</head>

<body>
    <div class="mask"></div>
    <header>
        <div class="leftHeader"></div>
        <div class="search">
            <input type="search" placeholder="ฅ Search Bing " id="searchInput" autocomplete="off" />

            <!-- <ul class=" association ">
                <li><a href=" ">aiosdja</a></li>
                <li><a href=" ">aiosdja</a></li>
                <li><a href=" ">你好，世界</a></li>
                <li><a href=" ">aiosdja</a></li>
            </ul> -->
        </div>

        <div class="rightTop">
            <div class="options">
                <button>Options</button>
                <div class="optionAlt">click to change ฅ•̀∀•́ฅ background!</div>
                <div class="nekoBg">
                    <ul class="bgTitle">
                        <li><button>Background</button></li>
                    </ul>
                    <ul class="bgBody">
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                        <li><button></button></li>
                    </ul>
                </div>
            </div>
            <div class="clock">
                <div class="timeClock"></div>
                <div class="dailyClock"><span></span><span></span></div>
            </div>
        </div>
    </header>
    <div class="content "></div>
    <footer>
        <div class="tools ">
            <div class="noteCtl ">ฅ New Notes</div>
        </div>
        <div class="support "></div>
    </footer>

    <div class="clearNotes">
        <div>
            <div class="alertSign"></div>
            <p>要删掉所有便签吗\(=‘ｘ‘=)</p>
            <div><button>不删了</button>
                <button>删掉</button>
            </div>
            <div class="leftEar"></div>
            <div class="rightEar"></div>
        </div>
    </div>

    <!-- note example -->
    <!-- <div class="note ">
        <div class="noteTitle "><button>+</button><button>×</button></div>
        <textarea name=" " id=" " cols="30 " rows="10 "></textarea>
    </div> -->


    <!-- <ul class="colorMenu">
        <li><button>blue</button></li>
        <li><button>green</button></li>
        <li><button>pink</button></li>
        <li><button>purple</button></li>
        <li><button>yellow</button></li>
        <li><button>white</button></li>
    </ul> -->



    <script>
        let header = document.querySelector('header')
        let content = document.querySelector('.content')
        let noteCtl = document.querySelector('.noteCtl')
        let clearNotes = document.querySelector('.clearNotes')
        let hasRemainNote = false
        //  blue green pink purple yellow white
        let noteHeadColor = ['#C9ECF8', '#C8F8C3', '#F1C3F1', '#D6CFFE', '#FDFCBF', '#F5F5F5']
        let noteBodyColor = ['#C0E1F5', '#A3ED9B', '#ECB2EC', '#CBC0FE', '#FCFAAE', '#ECECEC']
        // 笔记位置信息 [xPos,yPos]
        let noteStartPos = [
            '4.2%', '13.3%'
        ]
        // localStorage存储信息
        let notesInfo = {}


        //-------------------------------------------------------
        //                  便签控制
        //-------------------------------------------------------

        noteCtl.addEventListener('click', function (e) {

            if (hasRemainNote) {
                /*清除所有笔记*/
                clearNotes.style.display = 'block'
            } else {
                /*新建一个笔记*/
                noteCtl.textContent = 'ฅ Clear Notes'

                let freshNote = newNote()
                let idShuffle = 'note_' + Math.random().toString(16).slice(2)
                freshNote.id = idShuffle
                hasRemainNote = true
            }
            saveToStorage()

        })

        // 清除笔记警示框

        let clearNotesBtns = clearNotes.querySelectorAll('button')

        clearNotesBtns[0].addEventListener('click', function (e) {
            clearNotes.style.display = 'none'
        })
        clearNotesBtns[1].addEventListener('click', function (e) {
            clearNotes.style.display = 'none'
            noteCtl.textContent = 'ฅ New Notes'
            let notes = Array.from(document.querySelectorAll('.note'))
            for (let note of notes) {
                note.remove()
            }
            hasRemainNote = false
        })

        //新建便签
        function newNote() {
            if (content.children.length >= 30) {
                alert('创建的neko笔记已达上限.\n请删除一些^ↀxↀ^')
                return false
            }
            // 新建元素
            let note = document.createElement('div')
            note.classList.add('note')
            let noteTitle = document.createElement('div')
            noteTitle.classList.add('noteTitle')
            let btn1 = document.createElement('button')
            let btn2 = document.createElement('button')
            btn1.textContent = '+'
            btn2.textContent = '×'
            noteTitle.append(btn1, btn2)
            let txar = document.createElement('textarea')
            let shuffleColor = Math.random() * noteHeadColor.length | 0
            noteTitle.style.backgroundColor = noteHeadColor[shuffleColor]
            txar.style.backgroundColor = noteBodyColor[shuffleColor]
            note.append(noteTitle, txar);
            // 创建位置
            if (hasRemainNote) {
                let prevEltBox = content.lastElementChild.getBoundingClientRect()
                let prevPosX = prevEltBox.x / window.innerWidth * 100
                let prevPosY = prevEltBox.y / window.innerHeight * 100
                let thisPosX = prevPosX + 2.4
                let thisPosY = prevPosY + 4.0
                if (parseFloat(thisPosY) / 100 * window.innerHeight + 150 >= window.innerHeight - 10) {
                    thisPosY = 13
                }
                if (parseFloat(thisPosX) / 100 * window.innerWidth + 200 >= window.innerWidth + 50) {
                    thisPosX = 24
                    thisPosY = 15
                }
                // notePos.push([thisPosX, thisPosY])
                note.style.left = thisPosX + '%'
                note.style.top = thisPosY + '%'
            } else {
                // debugger;
                note.style.left = noteStartPos[0]
                note.style.top = noteStartPos[1]
            }
            content.append(note)
            note.tabIndex = '0'
            txar.focus()
            hasRemainNote = true
            //新建与关闭
            note.addEventListener('click', function (e) {
                if (e.target == btn1) {
                    let freshNote = newNote()
                    if (freshNote === false) {
                        return
                    }
                    let idShuffle = 'note_' + Math.random().toString(16).slice(2)
                    freshNote.id = idShuffle
                    saveToStorage()
                } else if (e.target == btn2) {
                    // let idx = Array.from(content.children).findIndex(it => it === this)
                    content.removeChild(this)
                    if (content.children.length == 0) {
                        hasRemainNote = false
                        noteCtl.textContent = 'ฅ New Notes'
                    }
                    saveToStorage()
                }
            })
            // 键入Tab与切换tabindex
            txar.addEventListener('keydown', function (e) {
                if (e.key == 'Tab') { //问题：tabindex会抢夺txar里的光标，导致两者都触发
                    this.textContent += '\t'
                }
            })
            txar.addEventListener('input', debounce(250, saveToStorage))
            //创建右键菜单
            txar.addEventListener('contextmenu', createColorMenu)
            return note
        }

        function createColorMenu(e) {
            e.preventDefault()
            let colorMenu = document.createElement('ul')
            colorMenu.classList.add('colorMenu')
            for (let i = 0; i < noteBodyColor.length; i++) {
                let li = document.createElement('li')
                let btn = document.createElement('button')
                btn.addEventListener('click', function (ev) {
                    let boxPos = colorMenu.getBoundingClientRect()
                    let notes = Array.from(document.querySelectorAll('.note'))
                    let note = notes.findLast(it => {
                        let notePos = it.getBoundingClientRect()
                        if (boxPos.x >= notePos.x && boxPos.x <= notePos.x + notePos.width && boxPos.y >= notePos.y && boxPos.y <= notePos.y + notePos.height) {
                            return true
                        }
                        return false
                    })

                    note.children[1].style.backgroundColor = noteBodyColor[i]
                    note.children[0].style.backgroundColor = noteHeadColor[i]
                })
                li.append(btn)
                colorMenu.append(li)
            }
            colorMenu.children[0].firstElementChild.textContent = 'blue'
            colorMenu.children[1].firstElementChild.textContent = 'green'
            colorMenu.children[2].firstElementChild.textContent = 'pink'
            colorMenu.children[3].firstElementChild.textContent = 'purple'
            colorMenu.children[4].firstElementChild.textContent = 'yellow'
            colorMenu.children[5].firstElementChild.textContent = 'white'
            colorMenu.style.left = e.clientX + 'px'
            colorMenu.style.top = e.clientY + 'px'
            document.body.append(colorMenu)
            return colorMenu
        }

        //简单写个findLast
        Array.prototype.findLast = function (predicate) {
            for (let i = this.length - 1; i >= 0; i--) {
                if (predicate(this[i], i, this)) {
                    return this[i]
                }
            }
            return
        }


        //删除右键菜单colorMenu
        window.addEventListener('click', function (e) {
            let colorMenus = document.querySelectorAll('ul.colorMenu')
            if (colorMenus.length) {
                for (let item of colorMenus) {
                    item.remove()
                }
            }
        })
        window.addEventListener('contextmenu', function (e) {
            let colorMenus = document.querySelectorAll('ul.colorMenu')
            if (colorMenus.length) {
                for (let item of colorMenus) {
                    item.remove()
                }
            }
            if (e.target.matches('.note>textarea')) {
                setTimeout(() => {
                    createColorMenu(e)
                })
            }
        })


        //聚焦提升z-index
        window.addEventListener('focusin', function (e) {
            // if (e.target.matches('.note')) {
            if (e.target.matches('.note>textarea')) {
                let note = e.target.parentElement
                note.style.zIndex = 1 + Array.from(content.children).reduce((max, it) => Math.max(max, it.style.zIndex), -Infinity)
                note.style.resize = 'both'
            }
        })

        //失焦平级z-index
        window.addEventListener('focusout', function (e) {
            if (e.target.matches('.note>textarea')) {
                // let note = e.target.parentElement
                Array.from(content.children).forEach(note => {
                    note.style.zIndex = 10
                    note.style.resize = 'none'
                })
            }
        })


        //移动note
        window.addEventListener('mousedown', function (e) {
            if (e.target.matches('.noteTitle')) {
                let note = e.target.parentElement
                let noteBoxPos = note.getBoundingClientRect()
                let mouseInNote = {
                    x: e.clientX - noteBoxPos.x,
                    y: e.clientY - noteBoxPos.y
                }
                /*问题：无法在mousedown时focus焦点,异步才能触发获焦。顺序:mousedown,blur,focus*/
                setTimeout(() => {
                    note.lastElementChild.focus()
                })
                // console.log(note.lastElementChild);
                // debugger;
                note.style.zIndex = 1 + Array.from(content.children).reduce((max, it) => Math.max(max, it.style.zIndex), -Infinity)

                function noteMoving(ev) {
                    let left = ev.clientX - mouseInNote.x
                    let top = ev.clientY - mouseInNote.y
                    note.style.left = left + 'px'
                    note.style.top = top + 'px'
                }

                function noteMoved(ev) {
                    let left = ev.clientX - mouseInNote.x
                    let top = ev.clientY - mouseInNote.y
                    let headerInfo = header.getBoundingClientRect()
                    //排斥
                    if (top < headerInfo.height) {
                        top = headerInfo.height + 2
                    }
                    if (top > window.innerHeight - 30) {
                        top = window.innerHeight - 30
                    }
                    if (left < -160) {
                        left = -160
                    }
                    if (left > window.innerWidth - 40) {
                        left = window.innerWidth - 40
                    }
                    note.style.left = left + 'px'
                    note.style.top = top + 'px'
                }

                window.addEventListener('mousemove', noteMoving)
                window.addEventListener('mouseup', function once(e) {
                    noteMoved(e)
                    note.lastElementChild.focus()
                    saveToStorage()
                    window.removeEventListener('mousemove', noteMoving)
                    window.removeEventListener('mouseup', once)
                })
            }
        })




        //-------------------------------------------------------

        //本地存储
        window.addEventListener('storage', updateFromStorage)
        window.addEventListener('focus', updateFromStorage)

        function updateFromStorage() {
            content.innerHTML = ''
            hasRemainNote = false
            let notes = JSON.parse(localStorage.getItem('notes')) || {}
            for (let id in notes) {
                let note = newNote()
                note.id = id
                note.firstElementChild.style.backgroundColor = notes[id].headColor
                note.lastElementChild.style.backgroundColor = notes[id].bodyColor
                note.style.width = notes[id].width
                note.style.height = notes[id].height
                note.style.left = notes[id].left
                note.style.top = notes[id].top
                note.style.zIndex = notes[id].zIndex
                note.lastElementChild.value = notes[id].content
            }
            let noteCtlLabelInfo = JSON.parse(localStorage.getItem('noteCtl'))
            hasRemainNote = noteCtlLabelInfo.hasRemainNote
            noteCtl.textContent = noteCtlLabelInfo.content
        }



        function saveToStorage() {
            let notes = Array.from(document.querySelectorAll('.note'))
            let notesInfo = notes.reduce((accum, note) => {
                let noteInfo = note.getBoundingClientRect()
                accum[note.id] = {
                    headColor: `${note.firstElementChild.style.backgroundColor}`,
                    bodyColor: `${note.lastElementChild.style.backgroundColor}`,
                    left: `${noteInfo.left}px`,
                    top: `${noteInfo.top}px`,
                    zIndex: `${note.style.zIndex}`,
                    width: `${noteInfo.width}px`,
                    height: `${noteInfo.height}px`,
                    content: `${note.lastElementChild.value}`,
                }
                return accum
            }, {});
            localStorage.removeItem('notes')
            localStorage.setItem('notes', JSON.stringify(notesInfo))

            let noteCtlLabel = document.querySelector('.noteCtl')
            let noteCtlLabelInfo = {
                content: noteCtlLabel.textContent,
                hasRemainNote: hasRemainNote
            }
            localStorage.setItem('noteCtl', JSON.stringify(noteCtlLabelInfo))

        }



        //-------------------------------------------------------

        //搜索联想
        let searchForm = document.querySelector('.search') //form
        let searchInput = searchForm.firstElementChild //input
        // let association = searchForm.lastElementChild //ul
        let curSuggestStart = 0
        //联想数据
        searchInput.addEventListener('input', debounce(200, e => {
            // this.value
            let startTime = Date.now()
            getAssociation(searchInput.value, (suggests) => {
                if (startTime < curSuggestStart) {
                    return -1
                }
                curSuggestStart = startTime
                //添加li到ul中
                let idx = Array.from(searchForm.children).findIndex(it => it.matches('.association'))
                if (idx != -1) {
                    searchForm.children[idx].remove()
                }
                let ans = JSON.parse(suggests)
                if (ans.AS.FullResults == 1) { //等于0说明无联想
                    let association = document.createElement('ul')
                    association.classList.add('association')

                    ans.AS.Results[0].Suggests.forEach(data => {
                        let li = document.createElement('li')
                        let anchor = document.createElement('a')
                        anchor.textContent = data.Txt
                        anchor.href = `https://cn.bing.com/search?q=${data.Txt}`
                        li.append(anchor)
                        association.append(li)

                    })
                    searchForm.append(association)
                    // searchForm.setAttribute('action', `https://cn.bing.com/search?q=${searchInput.value}`)
                }
            })
        }))
        //切换搜索目标
        let searchPos = -1
        let inputTargetIsUl = false
        searchInput.addEventListener('keydown', function (e) {
            let hasUl = searchForm.lastElementChild.matches('.association')

            // 上下
            if (e.key == 'ArrowDown') {
                searchPos++
                // this.selectionStart = this.selectionEnd = this.value.length
            } else if (e.key == 'ArrowUp') {
                searchPos--
                // this.selectionStart = this.selectionEnd = this.value.length
                // console.log(this.selectionStart, this.selectionEnd, this.value.length);
            }

            if (hasUl) {
                let ul = searchForm.lastElementChild
                let ulInfo = ul.getBoundingClientRect()
                let lis = Array.from(ul.children)
                // ul.addEventListener('mousemove', function(e) {
                //放弃根据光标位置高亮<a>，选择css的方式高亮
                //     searchPos = lis.findIndex(li => li.firstElementChild == e.target)
                //     console.log(searchPos);
                // })
                if (searchPos >= lis.length) {
                    searchPos = lis.length - 1
                }
                lis.forEach(li => {
                    li.children[0].className = ''
                })
                if (searchPos >= 0) {
                    lis[searchPos].firstElementChild.classList.add('searchHover')
                } else {
                    searchPos = -1
                }
            } else {
                searchPos = -1
            }


            if (e.key == 'Enter') {
                if (!hasUl) {
                    // searchPos = -1
                    let anchor = document.createElement('a')
                    anchor.href = `https://cn.bing.com/search?q=${searchInput.value}`
                    anchor.click()
                } else {

                    if (searchPos < 0) { //决定了回车搜索的是input还是ul>a
                        // searchPos = -1
                        let anchor = document.createElement('a')
                        anchor.href = `https://cn.bing.com/search?q=${searchInput.value}`
                        anchor.click()
                    } else {
                        let selectedLi = Array.from(searchForm.lastElementChild.children).find(li => {
                            return li.firstElementChild.classList.contains('searchHover')
                        })
                        selectedLi.firstElementChild.click()
                    }
                }

            }

        })

        searchInput.addEventListener('keyup', function (e) {
            if (e.key == 'ArrowDown') {
                this.selectionStart = this.selectionEnd = this.value.length
            } else if (e.key == 'ArrowUp') {
                this.selectionStart = this.selectionEnd = this.value.length
            }
        })



        function getAssociation(word, callback) {
            let xhr = new XMLHttpRequest()
            xhr.open('get', `https://sg1.api.bing.com/qsonhs.aspx?type=cb&q=${word}`)
            xhr.addEventListener('load', function (e) {
                // console.log(xhr.responseText);
                callback(xhr.responseText)
            })

            xhr.send()
        }


        function debounce(duration, f) {
            let id
            return function (...args) {
                clearTimeout(id)
                id = setTimeout(() => {
                    f.call(this, ...args)
                }, duration)
            }
        }


        // 背景图换调
        window.addEventListener('DOMContentLoaded', function (e) {
            let idx = 1 + (Math.random() * 185 | 0)
            if (idx <= 75 && idx >= 71) {
                document.body.style.backgroundImage = `url(noteImages/bg-${idx}.gif)`
            } else {
                document.body.style.backgroundImage = `url(noteImages/bg-${idx}.jpg)`
            }
            updateFromStorage()
            // console.log(document.readyState);
        })
        window.addEventListener('load', function (e) {
            let mask = document.querySelector('.mask')
            mask.classList.add('loading')

            initBgBody()
        })

        // 设置猫猫背景选项

        function initBgBody() {
            // debugger;
            let nekoBg = document.querySelector('.nekoBg')
            let bgBody = nekoBg.children[1]
            let nekoLis = Array.from(bgBody.children)
            for (let i = 0; i < nekoLis.length; i++) {
                if (i <= 74 && i >= 70) {
                    nekoLis[i].firstElementChild.style.backgroundImage = `url(noteImages/bg-${i + 1}.gif)`
                } else {
                    nekoLis[i].firstElementChild.style.backgroundImage = `url(noteImages/bg-${i + 1}.jpg)`
                }
            }
        }

        let nekoBg = document.querySelector('.nekoBg')
        nekoBg.children[1].addEventListener('click', function (e) {
            if (e.target.matches('button')) {
                document.body.style.backgroundImage = e.target.style.backgroundImage

                let mask = document.querySelector('.mask')
                mask.classList.remove('loading')
                setTimeout(() => {
                    mask.classList.add('loading')
                }, 100)

            }
        })

        //召唤Options菜单
        let optionsBtn = document.querySelector('.options>button')
        optionsBtn.addEventListener('click', function (e) {
            nekoBg.classList.add('seeNekoBg')
        })
        window.addEventListener('click', function (e) {
            if (!nekoBg.contains(e.target) && e.target !== optionsBtn) {
                nekoBg.classList.remove('seeNekoBg')
            }
        })
    </script>
    <script src="./moment.js">
    </script>
    <script>
        // 时钟模块
        let clock = document.querySelector('.clock')
        let timeClock = clock.querySelector('.timeClock')
        let dailyClock = clock.querySelector('.dailyClock')
        let weekTable = ['日', '一', '二', '三', '四', '五', '六']

        function updataTime() {
            timeClock.textContent = moment().format('kk:mm')
            dailyClock.children[0].textContent = '周' + weekTable[Number(moment().format('d'))] + '     |'
            dailyClock.children[1].textContent = moment().format('    YYYY.M.D')
        }
        setInterval(() => {
            // console.log(moment(Date.now()).format('kk:mm  d  YYYY.M.D'));
            // console.log(moment(Date.now()).format('d  YYYY.M.D'));
            updataTime()
        }, 1000);

        updataTime()
    </script>
</body>

</html>