<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neko memo ฅ(๑˙o˙๑)ฅ</title>
    <link rel="shortcut icon" href="noteImages/128.png" type="image/x-icon">
    <style>
        html {
            width: 100%;
            height: 100%;
        }
        
        body {
            margin: 0;
            background: url(noteImages/bg-01.jpg) no-repeat 0 10%;
            background-size: cover;
        }
        
        ul {
            list-style: none;
        }
        
        a {
            color: black;
            text-decoration: none;
        }
        
        header {
            display: flex;
            height: 80px;
            justify-content: space-between;
            align-items: center;
        }
        
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            /* background-color: rgba(0, 0, 0, .3); */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .noteCtl {
            box-sizing: border-box;
            height: 100%;
            line-height: 50px;
            cursor: pointer;
            color: #fff;
            padding-left: 8px;
            padding-right: 8px;
            margin-left: 20px;
            margin-right: 20px;
            font-size: 16px;
            font-family: consolas, 'Arial';
            border-radius: 6px;
            user-select: none;
        }
        
        .noteCtl:hover {
            transition: .2s;
            background-color: rgba(0, 0, 0, .3);
        }
        
        .content {
            /* border: 1px solid lightcoral; */
        }
        /* 每个note */
        
        .note {
            position: fixed;
            z-index: 10;
            /* left: 200px; */
            left: 4.2%;
            top: 13.3%;
            width: 200px;
            height: 150px;
            box-sizing: border-box;
            resize: none;
            background-color: rgba(0, 0, 0, .3);
            box-shadow: 2px 3px 7px 0 rgba(0, 0, 0, 20%);
            overflow: hidden;
        }
        
        .note .noteTitle {
            position: relative;
            width: 100%;
            height: 30px;
        }
        
        .note .noteTitle button {
            display: none;
            position: absolute;
            top: 2px;
            height: 18px;
            width: 20px;
            font-size: 16px;
            font-weight: 900;
            color: #A6ADB1;
            background-color: transparent;
            border: none;
            margin-left: 3px;
            margin-right: 5px;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .note .noteTitle button:last-of-type {
            right: 0;
        }
        
        .note .noteTitle button:hover {
            color: #555;
        }
        
        .note textarea {
            width: 100%;
            height: calc(100% - 30px);
            resize: none;
            box-sizing: border-box;
            margin: 0;
            border: none;
            padding: 4px;
            padding-top: 8px;
            /* padding-right: 8px; */
            outline: none;
            font-size: 16px;
            font-family: 'Open Sans', sans-serif;
            line-height: 20px;
            color: #555;
            font-style: italic;
        }
        
        .note textarea::-webkit-scrollbar {
            position: absolute;
            right: 0;
            top: 0;
            z-index: 1;
            cursor: default;
            width: 8px;
            margin-left: 2px;
            background-color: transparent;
        }
        
        .note textarea::-webkit-scrollbar-thumb {
            display: none;
            width: 8px;
            background-color: #aaa;
            border-radius: 5px;
        }
        
        .note textarea::-webkit-scrollbar-button {
            display: block;
            height: 0;
            background-color: transparent;
        }
        
        .note:hover .noteTitle>button {
            display: block;
        }
        
        .note:hover textarea::-webkit-scrollbar-thumb {
            display: block;
        }
        /* 搜索框 */
        
        .search {
            width: 22%;
            height: 46px;
        }
        
        .search input {
            position: relative;
            display: block;
            box-sizing: border-box;
            padding-left: 8px;
            padding-right: 8px;
            font-size: 20px;
            font-family: 'Arial';
            line-height: 45px;
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            border-bottom: 3px solid #eeee;
            color: #333;
            background-color: transparent;
            transition: .35s;
        }
        
        .search input:focus {
            background-color: rgba(255, 255, 255, 0.66);
        }
        
        .associate li {
            width: 305px;
            height: 54px;
            border-radius: 5px;
            padding-top: 8px;
            padding-bottom: 8px;
        }
        
        .associate li>a {
            display: block;
            width: 100%;
            height: 38px;
        }
    </style>
</head>

<body>
    <header>
        <div class="leftHeader"></div>
        <form action="" method="get" class="search">
            <input type="search" placeholder="ฅ Search Bing " id="searchInput" />
            <ul class="associate">
                <li><a href="">aiosdja</a></li>
            </ul>
        </form>
        <div class="clock"></div>
    </header>
    <div class="content"></div>
    <footer>
        <div class="tools">
            <div class="noteCtl">ฅ New Notes</div>
        </div>
        <div class="support"></div>
    </footer>


    <!-- note example -->
    <!-- <div class="note">
        <div class="noteTitle"><button>+</button><button>×</button></div>
        <textarea name="" id="" cols="30" rows="10"></textarea>
    </div> -->





    <script>
        let header = document.querySelector('header')
        let content = document.querySelector('.content')
        let noteCtl = document.querySelector('.noteCtl')
        let hasRemainNote = false
        let noteHeadColor = ['#F5F5F5', '#FDFCBF', '#C9ECF8', '#C8F8C3', '#F1C3F1', '#D6CFFE']
        let noteBodyColor = ['#ECECEC', '#FCFAAE', '#C0E1F5', '#A3ED9B', '#ECB2EC', '#CBC0FE']


        // 笔记位置信息 [xPos,yPos]
        let noteStartPos = [
            '4.2%', '13.3%'
        ]


        // localStorage存储信息
        let notesInfo = {}

        noteCtl.addEventListener('click', function(e) {

            if (hasRemainNote) {
                /*清除所有笔记*/
                noteCtl.textContent = 'ฅ New Notes'

                let notes = Array.from(document.querySelectorAll('.note'))
                for (let note of notes) {
                    note.remove()
                }
                hasRemainNote = false
            } else {
                /*新建一个笔记*/
                noteCtl.textContent = 'ฅ Clear Notes'

                let freshNote = newNote()
                let idShuffle = 'note_' + Math.random().toString(16).slice(2)
                freshNote.id = idShuffle
                hasRemainNote = true
            }
            saveToStorage()

        })


        //    function 


        //新建便签
        function newNote() {
            if (content.children.length >= 30) {
                alert('创建的neko笔记已达上限.\n请删除一些^ↀxↀ^')
                return false
            }
            // 新建元素
            let note = document.createElement('div')
            note.classList.add('note')
            let noteTitle = document.createElement('div')
            noteTitle.classList.add('noteTitle')
            let btn1 = document.createElement('button')
            let btn2 = document.createElement('button')
            btn1.textContent = '+'
            btn2.textContent = '×'
            noteTitle.append(btn1, btn2)
            let txar = document.createElement('textarea')
            let shuffleColor = Math.random() * noteHeadColor.length | 0
            noteTitle.style.backgroundColor = noteHeadColor[shuffleColor]
            txar.style.backgroundColor = noteBodyColor[shuffleColor]
            note.append(noteTitle, txar);
            // 创建位置
            if (hasRemainNote) {
                let prevEltBox = content.lastElementChild.getBoundingClientRect()
                let prevPosX = prevEltBox.x / window.innerWidth * 100
                let prevPosY = prevEltBox.y / window.innerHeight * 100
                let thisPosX = prevPosX + 2.4
                let thisPosY = prevPosY + 4.0
                if (parseFloat(thisPosY) / 100 * window.innerHeight + 150 >= window.innerHeight - 10) {
                    thisPosY = 13
                }
                if (parseFloat(thisPosX) / 100 * window.innerWidth + 200 >= window.innerWidth + 50) {
                    thisPosX = 24
                    thisPosY = 15
                }
                // notePos.push([thisPosX, thisPosY])
                note.style.left = thisPosX + '%'
                note.style.top = thisPosY + '%'
            } else {
                // debugger;
                note.style.left = noteStartPos[0]
                note.style.top = noteStartPos[1]
            }
            content.append(note)
            note.tabIndex = '0'
            txar.focus()
            hasRemainNote = true
                //新建与关闭
            note.addEventListener('click', function(e) {
                    if (e.target == btn1) {
                        let freshNote = newNote()
                        if (freshNote === false) {
                            return
                        }
                        let idShuffle = 'note_' + Math.random().toString(16).slice(2)
                        freshNote.id = idShuffle
                        saveToStorage()
                    } else if (e.target == btn2) {
                        // let idx = Array.from(content.children).findIndex(it => it === this)
                        content.removeChild(this)
                        if (content.children.length == 0) {
                            hasRemainNote = false
                        }
                        saveToStorage()
                    }
                })
                // 键入Tab与切换tabindex
            txar.addEventListener('keydown', function(e) {
                if (e.key == 'Tab') { //问题：tabindex会抢夺txar里的光标，导致两者都触发
                    this.textContent += '\t'
                }
            })
            txar.addEventListener('input', debounce(250, saveToStorage))
            return note
        }



        //聚焦提升z-index
        window.addEventListener('focusin', function(e) {
            // if (e.target.matches('.note')) {
            if (e.target.matches('.note>textarea')) {
                let note = e.target.parentElement
                note.style.zIndex = 1 + Array.from(content.children).reduce((max, it) => Math.max(max, it.style.zIndex), -Infinity)
                note.style.resize = 'both'
            }
        })

        //失焦平级z-index
        window.addEventListener('focusout', function(e) {
            if (e.target.matches('.note>textarea')) {
                // let note = e.target.parentElement
                Array.from(content.children).forEach(note => {
                    note.style.zIndex = 10
                    note.style.resize = 'none'
                })
            }
        })


        //移动note
        window.addEventListener('mousedown', function(e) {
            if (e.target.matches('.noteTitle')) {
                let note = e.target.parentElement
                let noteBoxPos = note.getBoundingClientRect()
                let mouseInNote = {
                        x: e.clientX - noteBoxPos.x,
                        y: e.clientY - noteBoxPos.y
                    }
                    /*问题：无法在mousedown时focus焦点,异步才能触发获焦。顺序:mousedown,blur,focus*/
                setTimeout(() => {
                    note.lastElementChild.focus()
                })
                console.log(note.lastElementChild);
                // debugger;
                note.style.zIndex = 1 + Array.from(content.children).reduce((max, it) => Math.max(max, it.style.zIndex), -Infinity)

                function noteMoving(ev) {
                    let left = ev.clientX - mouseInNote.x
                    let top = ev.clientY - mouseInNote.y
                    note.style.left = left + 'px'
                    note.style.top = top + 'px'
                }

                function noteMoved(ev) {
                    let left = ev.clientX - mouseInNote.x
                    let top = ev.clientY - mouseInNote.y
                    let headerInfo = header.getBoundingClientRect()
                        //排斥
                    if (top < headerInfo.height) {
                        top = headerInfo.height + 2
                    }
                    if (top > window.innerHeight - 30) {
                        top = window.innerHeight - 30
                    }
                    if (left < -160) {
                        left = -160
                    }
                    if (left > window.innerWidth - 40) {
                        left = window.innerWidth - 40
                    }
                    note.style.left = left + 'px'
                    note.style.top = top + 'px'
                }

                window.addEventListener('mousemove', noteMoving)
                window.addEventListener('mouseup', function once(e) {
                    noteMoved(e)
                    note.lastElementChild.focus()
                    saveToStorage()
                    window.removeEventListener('mousemove', noteMoving)
                    window.removeEventListener('mouseup', once)
                })
            }
        })






        //本地存储
        window.addEventListener('storage', updateFromStorage)


        function updateFromStorage() {
            content.innerHTML = ''
            hasRemainNote = false
            let notes = JSON.parse(localStorage.getItem('notes')) || {}
            for (let id in notes) {
                let note = newNote()
                note.id = id
                note.firstElementChild.style.backgroundColor = notes[id].headColor
                note.lastElementChild.style.backgroundColor = notes[id].bodyColor
                note.style.width = notes[id].width
                note.style.height = notes[id].height
                note.style.left = notes[id].left
                note.style.top = notes[id].top
                note.style.zIndex = notes[id].zIndex
                note.lastElementChild.value = notes[id].content
            }
            let noteCtlLabelInfo = JSON.parse(localStorage.getItem('noteCtl'))
            hasRemainNote = noteCtlLabelInfo.hasRemainNote
            noteCtl.textContent = noteCtlLabelInfo.content
        }



        function saveToStorage() {
            let notes = Array.from(document.querySelectorAll('.note'))
            let notesInfo = notes.reduce((accum, note) => {
                let noteInfo = note.getBoundingClientRect()
                accum[note.id] = {
                    headColor: `${note.firstElementChild.style.backgroundColor}`,
                    bodyColor: `${note.lastElementChild.style.backgroundColor}`,
                    left: `${noteInfo.left}px`,
                    top: `${noteInfo.top}px`,
                    zIndex: `${note.style.zIndex}`,
                    width: `${noteInfo.width}px`,
                    height: `${noteInfo.height}px`,
                    content: `${note.lastElementChild.value}`,
                }
                return accum
            }, {});
            localStorage.removeItem('notes')
            localStorage.setItem('notes', JSON.stringify(notesInfo))

            let noteCtlLabel = document.querySelector('.noteCtl')
            let noteCtlLabelInfo = {
                content: noteCtlLabel.textContent,
                hasRemainNote: hasRemainNote
            }
            localStorage.setItem('noteCtl', JSON.stringify(noteCtlLabelInfo))

        }





        //搜索联想
        let searchForm = document.querySelector('.search')
        let searchInput = searchForm.firstElementChild //input
        let association = searchForm.lastElementChild //ul
        let curSuggestStart = 0
        searchInput.addEventListener('input', debounce(250, e => {
            // this.value
            let startTime = Date.now()
            getAssociation(this.value, (suggests) => {
                if (startTime < curSuggestStart) {
                    return -1
                }
                curSuggestStart = startTime
                    //添加li到ul中
            })
        }))





        function getAssociation(word, callback) {
            let xhr = new XMLHttpRequest()
            xhr.open('get', `https://sg1.api.bing.com/qsonhs.aspx?type=cb&q=${word}`)
            xhr.addEventListener('load', function(e) {
                callback(xhr.responseText)
            })

            xhr.send()
        }


        function debounce(duration, f) {
            let id
            return function(...args) {
                clearTimeout(id)
                id = setTimeout(() => {
                    f.call(this, ...args)
                }, duration)
            }
        }
    </script>
</body>

</html>